<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulaire Astreinte ENEDIS</title>
<style>
:root { --primary:#0a70ff; --bg:#f7f8fa; --card:#ffffff; --border:#e4e6eb; --section-bg:#eaf3ff; }
* { box-sizing: border-box; }
body { margin:0; font-family: 'Calibri Light', Calibri, 'Segoe UI', Arial, sans-serif; background:var(--bg); color:#111; }
header { background:#0a70ff; color:#fff; padding:16px; text-align:center; font-weight:700; }
header .logo { display:block; margin:0 auto 8px; max-height:56px; width:auto; }
header .title { font-size:18px; letter-spacing:.2px; }
main { max-width: 760px; margin: 16px auto 32px; padding: 0 12px; }
form { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow: 0 6px 16px rgba(10,20,30,.06); }
h2 { margin: 0 0 16px; font-size: 18px; color: var(--primary); background: var(--section-bg); padding:8px 12px; border-radius:8px; }
.row { display:flex; gap:12px; flex-wrap:wrap; }
.col { flex:1; min-width: 240px; }
label { font-weight:600; display:block; margin: 14px 0 6px; color: var(--primary); }
.section { background: var(--section-bg); padding:8px 12px; border-radius:8px; }
input[type="text"], input[type="date"], input[type="time"], textarea, select {
width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:16px;
font-family: 'Calibri Light', Calibri, 'Segoe UI', Arial, sans-serif; color:#000;
}
textarea { min-height: 120px; resize: vertical; color:#000; }
small.hint { color:#666; display:block; margin-top:4px; }
.inline { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
.radio-group, .choice-group { display:grid; gap:8px; }
.radio-item, .choice-item {
display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#000;
}
.radio-item label { color:#000; }
.hidden { display:none; }
.btn {
display:inline-flex; align-items:center; justify-content:center; gap:8px;
border:none; background:var(--primary); color:#fff; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer;
font-family: 'Calibri Light', Calibri, 'Segoe UI', Arial, sans-serif;
}
.btn.secondary { background:#111; }
.btn.ghost { background:#fff; color:#111; border:1px solid var(--border); }
.btn:disabled { opacity:.6; cursor:not-allowed; }
.actions { display:flex; gap:12px; margin-top:18px; flex-wrap:wrap; }
.canvas-wrap { border:1px dashed var(--border); border-radius:12px; padding:10px; background:#fcfcfd; }
canvas { width:100%; height:180px; border:1px solid var(--border); border-radius:10px; background:#fff; touch-action: none; }
.stars { display:flex; gap:4px; direction: rtl; font-size: 28px; justify-content: flex-start; }
.stars input { display:none; }
.stars label { cursor: pointer; filter: grayscale(1); opacity:.6; transition: transform .08s ease; }
.stars input:checked ~ label,
.stars label:hover,
.stars label:hover ~ label { filter: none; opacity:1; }
.photo-preview { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
.photo-preview img { width:120px; height:120px; object-fit:cover; border-radius:10px; border:1px solid var(--border); }
.notice { background:#fff7e6; border:1px solid #ffe1a6; color:#7a4b00; padding:10px; border-radius:10px; }
</style>
</head>
<body>
<header>
<img class="logo" src="https://i.postimg.cc/XYPBTyBx/logo-SOGETREL.png" alt="Logo de l'entreprise" />
<div class="title">Formulaire Astreinte ENEDIS</div>
</header>

  <main>
            <form id="form" action="https://formspree.io/f/XXXXXXX" method="POST" enctype="multipart/form-data" novalidate>
        <h2>D√©tails de l‚Äôintervention</h2>

      <!-- Adresse + g√©olocalisation (adresse compl√®te, sans lat/lng visibles) -->
      <label for="adresse" class="section">Adresse de l'intervention</label>
      <div class="inline">
        <input id="adresse" name="adresse_intervention" type="text" placeholder="Saisir l‚Äôadresse compl√®te‚Ä¶" required />
        <button type="button" id="btnGeo" class="btn ghost" aria-label="Utiliser la g√©olocalisation">üìç Utiliser ma position</button>
      </div>
      <small class="hint">¬´ Utiliser ma position ¬ª remplit automatiquement l‚Äôadresse compl√®te (rue, code postal, ville). Vous pouvez corriger si besoin.</small>
      <div id="geoNotice" class="notice hidden">Adresse r√©cup√©r√©e automatiquement.</div>

      <!-- Contact ENEDIS -->
      <label for="contactEnedis" class="section">Contact ENEDIS</label>
      <input id="contactEnedis" name="contact_enedis" type="text" placeholder="Nom du contact ENEDIS" required />

      <!-- Technicien SOGETREL -->
      <label class="section">Technicien SOGETREL</label>
      <div class="radio-group" role="radiogroup" aria-label="Technicien SOGETREL">
        <div class="radio-item">
          <input type="radio" id="tech1" name="technicien_sogetrel" value="RAGON Philippe" required />
          <label for="tech1">RAGON Philippe</label>
        </div>
        <div class="radio-item">
          <input type="radio" id="tech2" name="technicien_sogetrel" value="ERDOGAN Sinan" />
          <label for="tech2">ERDOGAN Sinan</label>
        </div>
        <div class="radio-item">
          <input type="radio" id="techAutre" name="technicien_sogetrel" value="Autre" />
          <label for="techAutre">Autre (pr√©ciser)</label>
        </div>
      </div>
      <input id="techAutreNom" name="technicien_autre_nom" type="text" class="hidden" placeholder="Nom du technicien (si Autre)">

      <!-- Date + Heures -->
      <div class="row">
        <div class="col">
          <label for="dateInter" class="section">Date d'intervention</label>
          <input id="dateInter" name="date_intervention" type="date" required />
        </div>
        <div class="col">
          <label for="heureAppel" class="section">Heure d'appel</label>
          <input id="heureAppel" name="heure_appel" type="time" inputmode="numeric" step="60" required />
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label for="heureArrivee" class="section">Heure d'arriv√©e</label>
          <input id="heureArrivee" name="heure_arrivee" type="time" inputmode="numeric" step="60" required />
        </div>
        <div class="col">
          <label for="heureDepart" class="section">Heure de d√©part</label>
          <input id="heureDepart" name="heure_depart" type="time" inputmode="numeric" step="60" required />
        </div>
      </div>

      <!-- Type de finition -->
      <label class="section">Type de finition</label>
      <div class="choice-group">
        <label class="choice-item">
          <input type="radio" name="type_finition" value="Terre/Concass√©" required /> Terre/Concass√©
        </label>
        <label class="choice-item">
          <input type="radio" name="type_finition" value="B√©ton" /> B√©ton
        </label>
        <label class="choice-item">
          <input type="radio" name="type_finition" value="Enrob√©" /> Enrob√©
        </label>
      </div>

      <!-- Utilisation du BRH -->
      <label class="section">Utilisation du BRH</label>
      <div class="choice-group">
        <label class="choice-item">
          <input type="radio" name="utilisation_brh" value="Oui" required /> Oui
        </label>
        <label class="choice-item">
          <input type="radio" name="utilisation_brh" value="Non" /> Non
        </label>
      </div>

      <!-- Dimension de la fouille -->
      <label for="dimensionFouille" class="section">Dimension de Fouille</label>
      <textarea id="dimensionFouille" name="dimension_fouille" placeholder="Ex : 1,2 m (L) √ó 0,8 m (l) √ó 0,6 m (p)"></textarea>

      <!-- Photo de la fouille -->
      <label for="photoFouille" class="section">Photo de la fouille</label>
      <input id="photoFouille" name="photo_fouille" type="file" accept="image/*" capture="environment" />
      <small class="hint">Prendre une photo (cam√©ra) ou choisir une image depuis le t√©l√©phone.</small>
      <div id="photoPreview" class="photo-preview"></div>

      <!-- Fermeture possible √† partir de -->
      <label for="dateFermeture" class="section">Fermeture possible √† partir de</label>
      <input id="dateFermeture" name="fermeture_possible_a_partir_de" type="date" />

      <!-- Commentaire libre -->
      <label for="commentaireLibre" class="section">Commentaire libre</label>
      <textarea id="commentaireLibre" name="commentaire_libre" rows="8" placeholder="Saisir un commentaire (8 lignes)..."></textarea>

      <!-- Satisfaction client (√©toiles de droite √† gauche) -->
      <label class="section">Satisfaction client</label>
      <div class="stars" aria-label="Satisfaction client (5 = tr√®s satisfait)">
        <input type="radio" id="star5" name="satisfaction" value="5"><label for="star5" title="5">‚≠ê</label>
        <input type="radio" id="star4" name="satisfaction" value="4"><label for="star4" title="4">‚≠ê</label>
        <input type="radio" id="star3" name="satisfaction" value="3"><label for="star3" title="3">‚≠ê</label>
        <input type="radio" id="star2" name="satisfaction" value="2"><label for="star2" title="2">‚≠ê</label>
        <input type="radio" id="star1" name="satisfaction" value="1"><label for="star1" title="1">‚≠ê</label>
      </div>

      <!-- Signatures -->
      <h2>Signatures</h2>
      <div class="row">
        <div class="col">
          <label class="section">Signature ENEDIS</label>
          <div class="canvas-wrap">
            <canvas id="sigEnedis"></canvas>
            <div class="actions">
              <button type="button" class="btn secondary" id="clearEnedis">Effacer</button>
            </div>
          </div>
          <input type="hidden" name="signature_enedis_png" id="sigEnedisData" />
        </div>
        <div class="col">
          <label class="section">Signature SOGETREL</label>
          <div class="canvas-wrap">
            <canvas id="sigSogetrel"></canvas>
            <div class="actions">
              <button type="button" class="btn secondary" id="clearSogetrel">Effacer</button>
            </div>
          </div>
          <input type="hidden" name="signature_sogetrel_png" id="sigSogetrelData" />
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn">Soumettre</button>
      </div>
    </form>
  </main>

  <script>
    // --- Technicien "Autre (pr√©ciser)" ---
    const techRadios = document.querySelectorAll('input[name="technicien_sogetrel"]');
    const techAutre = document.getElementById('techAutre');
    const techAutreNom = document.getElementById('techAutreNom');
    techRadios.forEach(r => r.addEventListener('change', () => {
      if (techAutre.checked) {
        techAutreNom.classList.remove('hidden');
        techAutreNom.required = true;
        techAutreNom.focus();
      } else {
        techAutreNom.classList.add('hidden');
        techAutreNom.required = false;
        techAutreNom.value = '';
      }
    }));

    // --- G√©olocalisation + reverse geocoding (adresse compl√®te, pas de lat/lng affich√©s) ---
    const btnGeo = document.getElementById('btnGeo');
    const adresse = document.getElementById('adresse');
    const geoNotice = document.getElementById('geoNotice');

    btnGeo.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert("La g√©olocalisation n'est pas support√©e par ce navigateur.");
        return;
      }
      btnGeo.disabled = true; btnGeo.textContent = "Localisation‚Ä¶";

      const controller = new AbortController();
      const geoTimeout = setTimeout(() => controller.abort(), 12000);

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          // Reverse geocoding via Nominatim (OpenStreetMap)
          const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(latitude)}&lon=${encodeURIComponent(longitude)}&addressdetails=1&zoom=18`;
          fetch(url, { headers: { 'Accept': 'application/json' }, signal: controller.signal })
            .then(r => r.ok ? r.json() : Promise.reject(new Error('R√©ponse invalide')))
            .then(data => {
              const a = data.address || {};
              const parts = [
                [a.house_number, a.road].filter(Boolean).join(' '),
                a.suburb || a.neighbourhood || '',
                a.postcode || '',
                a.city || a.town || a.village || a.municipality || a.county || '',
                a.state || '',
                a.country || ''
              ].filter(Boolean);
              const full = parts.join(', ');
              adresse.value = full || data.display_name || adresse.value;
              geoNotice.classList.remove('hidden');
            })
            .catch(() => {
              alert("Adresse introuvable automatiquement. Merci de saisir l'adresse manuellement.");
            })
            .finally(() => {
              clearTimeout(geoTimeout);
              btnGeo.disabled = false; btnGeo.textContent = "üìç Utiliser ma position";
            });
        },
        err => {
          clearTimeout(geoTimeout);
          alert("Impossible d'obtenir la position : " + err.message);
          btnGeo.disabled = false; btnGeo.textContent = "üìç Utiliser ma position";
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    });

    // --- Pr√©visualisation de la photo ---
    const photoInput = document.getElementById('photoFouille');
    const photoPreview = document.getElementById('photoPreview');
    photoInput.addEventListener('change', () => {
      photoPreview.innerHTML = '';
      const file = photoInput.files && photoInput.files[0];
      if (!file) return;
      const img = document.createElement('img');
      img.alt = 'Photo de la fouille';
      img.src = URL.createObjectURL(file);
      photoPreview.appendChild(img);
    });

    // --- Signature pads (g√©n√©rique) ---
    function initSignature(canvasId, clearBtnId, hiddenInputId) {
      const canvas = document.getElementById(canvasId);
      const hidden = document.getElementById(hiddenInputId);
      const clearBtn = document.getElementById(clearBtnId);
      const ctx = canvas.getContext('2d');
      let drawing = false;

      function resizeCanvas() {
        const ratio = window.devicePixelRatio || 1;
        const displayWidth = canvas.clientWidth;
        const displayHeight = canvas.clientHeight;
        canvas.width = displayWidth * ratio;
        canvas.height = displayHeight * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#000";
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      function getPos(e) {
        if (e.touches && e.touches.length) {
          const rect = canvas.getBoundingClientRect();
          return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
        } else {
          return { x: e.offsetX, y: e.offsetY };
        }
      }

      function start(e) { e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
      function move(e) { if (!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x, p.y); }
      function end() { drawing = false; }

      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('mousemove', move);
      canvas.addEventListener('mouseup', end);
      canvas.addEventListener('mouseleave', end);
      canvas.addEventListener('touchstart', start, { passive:false });
      canvas.addEventListener('touchmove', move, { passive:false });
      canvas.addEventListener('touchend', end);

      clearBtn.addEventListener('click', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); hidden.value = ''; });

      return () => { hidden.value = canvas.toDataURL('image/png'); };
    }

    const serializeEnedis = initSignature('sigEnedis', 'clearEnedis', 'sigEnedisData');
    const serializeSogetrel = initSignature('sigSogetrel', 'clearSogetrel', 'sigSogetrelData');

    // --- Validation l√©g√®re + s√©rialisation signatures avant envoi ---
    const form = document.getElementById('form');
    form.addEventListener('submit', (e) => {
      const timeFields = ['heureAppel','heureArrivee','heureDepart'].map(id => document.getElementById(id));
      const timeRe = /^([01]\d|2[0-3]):[0-5]\d$/;
      for (const fld of timeFields) {
        if (!timeRe.test(fld.value)) {
          e.preventDefault();
          alert('Merci de saisir les heures au format 24h (HH:MM).');
          fld.focus();
          return;
        }
      }
      serializeEnedis();
      serializeSogetrel();
    });
  </script>
</body>
</html>
